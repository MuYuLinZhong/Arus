# 服务端总体设计说明书

**防盗安全预警系列 · 石油阀门 NFC 智能管控系统**

| 项目 | 内容 |
|------|------|
| 文档版本 | V2.0 |
| 编制日期 | 2026年2月 |
| 适用范围 | Go 服务端架构、多租户隔离、分组权限、终端设备管理、中间件、安全与可观测性 |
| 依据 | 数据库部分见 [数据库总体设计](../database/01-数据库总体设计.md) |

---

## 目录

1. [技术选型](#1-技术选型)
2. [目录结构与分层](#2-目录结构与分层)
3. [启动与生命周期](#3-启动与生命周期)
4. [配置管理](#4-配置管理)
5. [中间件链](#5-中间件链)
6. [路由与接口设计](#6-路由与接口设计)
7. [认证与会话管理](#7-认证与会话管理)
8. [核心业务：挑战-应答协议](#8-核心业务挑战-应答协议)
9. [管理后台业务](#9-管理后台业务)
10. [消息队列](#10-消息队列)
11. [安全设计](#11-安全设计)
12. [日志与可观测性](#12-日志与可观测性)
13. [统一响应与错误码](#13-统一响应与错误码)
14. [数据访问层](#14-数据访问层)
15. [构建与部署](#15-构建与部署)
16. [版本记录](#16-版本记录)

---

## 1. 技术选型

| 组件 | 选型 | 版本 | 说明 |
|------|------|------|------|
| 语言 | Go | 1.22 | 静态编译、高并发、部署简单 |
| HTTP 框架 | Gin | 1.9.1 | 高性能、中间件链式调用 |
| ORM | GORM + pgx | 1.25.7 | 自动映射、连接池、预编译 |
| 数据库 | PostgreSQL | 15+ | 分区表、JSONB、Upsert |
| 消息队列 | RabbitMQ | — | amqp091-go 驱动，可选组件 |
| 日志 | Zap | 1.27.0 | JSON 结构化日志 |
| 监控 | Prometheus client | 1.19.0 | 暴露 /metrics 端点 |
| 密码哈希 | Argon2id | — | golang.org/x/crypto |
| UUID | google/uuid | 1.6.0 | Token JTI、用户 UUID |

---

## 2. 目录结构与分层

```
server/
├── cmd/
│   ├── main.go                  # 入口：初始化 → 启动 HTTP → 优雅关机
│   └── hashpwd/main.go          # 工具：生成 Argon2 密码哈希
├── internal/
│   ├── config/config.go         # 配置加载（环境变量）
│   ├── router/router.go         # 路由注册与中间件挂载
│   ├── handler/                 # HTTP 层
│   │   ├── auth_handler.go
│   │   ├── lock_handler.go
│   │   ├── terminal_handler.go  # 终端设备鉴权与操作接口
│   │   ├── admin_handler.go     # 用户/设备/分组/权限/终端管理
│   │   └── health_handler.go
│   ├── service/                 # 业务层
│   │   ├── auth_service.go
│   │   ├── lock_service.go
│   │   ├── terminal_service.go  # 终端鉴权、授权校验、挑战代理
│   │   ├── group_service.go     # 设备分组、用户分组 CRUD
│   │   └── admin_service.go
│   ├── repository/              # 数据层
│   │   ├── database.go
│   │   ├── session_store.go
│   │   └── device_session_store.go
│   ├── model/                   # 数据模型
│   │   ├── models.go            # GORM 模型（含 tenant_id）
│   │   ├── response.go          # 统一响应信封、业务错误码
│   │   └── json.go              # JSONB 自定义类型
│   ├── middleware/               # Gin 中间件
│   │   ├── recovery.go
│   │   ├── request_id.go
│   │   ├── security.go          # 安全头 + CORS
│   │   ├── access_log.go
│   │   ├── ratelimit.go
│   │   ├── auth.go              # Token 鉴权（用户 + 设备双路径）
│   │   ├── tenant.go            # 租户上下文注入与隔离
│   │   └── hmac.go
│   ├── kms/kms.go               # 密钥管理
│   ├── crypto/
│   │   ├── aes.go
│   │   └── argon2.go
│   ├── mq/
│   │   ├── publisher.go
│   │   └── consumer.go
│   ├── logger/logger.go
│   └── metrics/prometheus.go
├── migrations/
│   └── 001_init.sql
├── Dockerfile
├── go.mod / go.sum
```

### 分层规则

| 层 | 包 | 职责 | 禁止 |
|----|-----|------|------|
| **HTTP 层** | handler | 参数绑定、调 Service、写 JSON 响应 | 直接操作 DB |
| **业务层** | service | 核心规则、权限校验、租户隔离、挑战-应答 | 直接读写 HTTP 请求/响应 |
| **数据层** | repository | DB 连接、事务、Store 接口实现 | 业务规则判断 |
| **模型层** | model | GORM 结构体（含 `tenant_id`）、TableName、错误码 | 任何逻辑 |

调用方向：handler → service → repository/model，禁止反向或跨层。

---

## 3. 启动与生命周期

`cmd/main.go` 按以下顺序初始化，任一核心组件失败则拒绝启动：

```
① config.Load()             读取环境变量
② logger.Init()             Zap 初始化
③ gin.SetMode()             设置 Gin 运行模式
④ repository.InitDB()       GORM 连接 PostgreSQL + Ping
⑤ kms.Init()                加载主密钥
⑥ middleware.SetTokenSecret  设置 Token HMAC 密钥
⑦ metrics.Init()            注册 Prometheus 指标
⑧ mq.NewPublisher()         连接 RabbitMQ（可选，失败不阻塞）
⑨ mq.NewAuditConsumer()     启动审计消费者（可选）
⑩ 构建 Service / Handler / Router
⑪ http.Server.ListenAndServe()
⑫ startSessionCleaner()     每小时清理过期 Session + DeviceSession
⑬ 监听 SIGINT/SIGTERM → Shutdown(10s) → 退出
```

**RabbitMQ 可选降级**：连接失败不阻塞启动，`publisher = nil` 时跳过消息发布。开锁挑战-应答不因 MQ 故障阻塞。

---

## 4. 配置管理

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|---------|--------|------|
| 端口 | `SERVER_PORT` | 8080 | HTTP 监听端口 |
| 运行模式 | `GIN_MODE` | debug | debug / release |
| DB Host | `DB_HOST` | localhost | |
| DB Port | `DB_PORT` | 5432 | |
| DB 用户 | `DB_USER` | promthus | |
| DB 密码 | `DB_PASSWORD` | promthus | |
| DB 库名 | `DB_NAME` | promthus | |
| DB 最大连接 | `DB_MAX_OPEN_CONNS` | 50 | |
| RabbitMQ | `RABBITMQ_URL` | amqp://guest:guest@localhost:5672/ | |
| Token 密钥 | `AUTH_TOKEN_SECRET` | change-me-in-production | HMAC-SHA256 |
| 主密钥路径 | `KMS_MASTER_KEY_PATH` | ./master.key | |

---

## 5. 中间件链

### 5.1 全局中间件

| 顺序 | 中间件 | 作用 | 失败行为 |
|------|--------|------|---------|
| 1 | **Recovery** | 捕获 panic，记录堆栈 | 500 |
| 2 | **RequestID** | 生成 UUID，注入 Context + 响应头 | — |
| 3 | **SecurityHeaders** | HSTS、CSP、X-Frame-Options 等 | — |
| 4 | **CORS** | 跨域策略 | — |
| 5 | **AccessLog** | Zap JSON 请求日志 | — |
| 6 | **GlobalRateLimit** | IP 限流 100次/60s | 429 |

### 5.2 分组/路由级中间件

| 中间件 | 作用域 | 说明 |
|--------|--------|------|
| **LoginRateLimit** | `/api/auth/login` | IP 限流 10次/60s + IP 封锁 |
| **DeviceAuthRateLimit** | `/api/device/auth` | IP 限流 10次/60s |
| **Auth** | 需鉴权路由组 | 双路径 Token 解析（用户/设备），注入 user_id 或 device_id + **tenant_id** |
| **TenantScope** | Auth 之后 | 从 Context 取 tenant_id，注入到所有 DB 查询的 WHERE 条件中 |
| **RBAC** | admin 路由组 | 角色匹配：`tenant_admin` / `admin` |

### 5.3 租户隔离中间件（TenantScope）

Auth 中间件解析 Token 后已注入 `tenant_id`（从 sessions/device_sessions 表读取）。TenantScope 确保后续所有 Service 调用自动携带租户上下文：

```
c.Set("tenant_id", session.TenantID)
```

Service 层所有查询均通过 `WHERE tenant_id = ?` 过滤，**禁止**由客户端传入 tenant_id。

### 5.4 限流 Key 命名

| 场景 | Key 格式 |
|------|---------|
| 登录 | `login:ip:{ip}` |
| 挑战 | `challenge:{tenant_id}:lock:{device_id}` |
| 全局 | `global:ip:{ip}` |
| 终端认证 | `device_auth:ip:{ip}` |
| 终端挑战 | `terminal_challenge:{tenant_id}:{terminal_id}:{lock_device_id}` |

---

## 6. 路由与接口设计

### 6.1 路由总表

**公共端点**：

| 方法 | 路径 | 鉴权 | Handler |
|------|------|------|---------|
| GET | `/api/health` | 无 | Health |
| POST | `/api/auth/login` | 无 | AuthHandler.Login |
| POST | `/api/auth/logout` | Token | AuthHandler.Logout |
| GET | `/metrics` | 无 | Prometheus |

**操作员端点**（Token 鉴权，任意角色）：

| 方法 | 路径 | Handler | 说明 |
|------|------|---------|------|
| GET | `/api/lock/devices` | LockHandler.GetDevices | 当前用户授权设备列表（含分组展开） |
| POST | `/api/lock/challenge` | LockHandler.Challenge | 挑战-应答 |
| POST | `/api/lock/report` | LockHandler.Report | 上报开锁结果 |

**管理端点**（Token + tenant_admin / admin）：

| 方法 | 路径 | Handler |
|------|------|---------|
| GET | `/api/admin/dashboard` | AdminHandler.Dashboard |
| GET/POST | `/api/admin/users`, `/api/admin/users/:uuid` | 用户 CRUD |
| POST | `/api/admin/users/:uuid/reset-pwd` | 重置密码 |
| GET/POST | `/api/admin/devices` | 锁具设备 CRUD |
| GET/POST/PUT/DELETE | `/api/admin/device-groups[/:id]` | 设备分组 CRUD |
| POST | `/api/admin/device-groups/:id/members` | 添加/移除分组成员 |
| GET/POST/PUT/DELETE | `/api/admin/user-groups[/:id]` | 用户分组 CRUD |
| POST | `/api/admin/user-groups/:id/members` | 添加/移除分组成员 |
| GET/POST/DELETE | `/api/admin/permissions[/:id]` | 权限授权/撤销（支持四种组合） |
| POST | `/api/admin/permissions/batch` | 批量授权 |
| GET/POST/PUT | `/api/admin/terminals[/:device_id]` | 终端设备 CRUD |
| POST | `/api/admin/terminals/:device_id/bind` | 绑定终端到管理员 |
| POST | `/api/admin/terminals/:device_id/reset-secret` | 重置终端密钥 |
| GET/POST/DELETE | `/api/admin/terminal-bindings[/:id]` | 终端-锁具绑定 CRUD |
| POST | `/api/admin/terminal-bindings/batch` | 批量绑定 |
| POST | `/api/admin/ota/packages` | 上传 OTA 固件包 |
| POST | `/api/admin/ota/deploy` | 下发 OTA 更新 |
| GET | `/api/admin/audit-logs` | 审计日志 |
| GET/PUT | `/api/admin/alerts[/:id]` | 告警管理 |

**终端设备端点**（设备 Token 鉴权）：

| 方法 | 路径 | Handler | 说明 |
|------|------|---------|------|
| POST | `/api/device/auth` | TerminalHandler.Authenticate | 终端登录 |
| POST | `/api/device/heartbeat` | TerminalHandler.Heartbeat | 心跳 + OTA 检查 |
| GET | `/api/device/locks` | TerminalHandler.GetBoundLocks | 被授权的锁具列表 |
| POST | `/api/device/lock/challenge` | TerminalHandler.Challenge | 挑战-应答 |
| POST | `/api/device/lock/report` | TerminalHandler.Report | 上报开锁结果 |

### 6.2 统一响应格式

```json
{
  "code": 0,
  "message": "success",
  "data": { ... },
  "request_id": "uuid",
  "timestamp": 1708300000000
}
```

### 6.3 分页

- **审计日志**：游标分页（`cursor` + `limit`），返回 `next_cursor` + `has_more`。
- **其它列表**：偏移分页（`page` + `page_size`），返回 `items` + `total`。

---

## 7. 认证与会话管理

### 7.1 Token 格式

不使用 JWT，采用 **HMAC-SHA256 自签名 Token**：

```
用户 Token:   payload = user_uuid + ":" + jti
设备 Token:   payload = "device:" + device_id + ":" + jti
Token = Base64URL(payload) + "." + Base64URL(HMAC-SHA256(payload, secret))
```

### 7.2 登录流程

```
① 客户端 POST /api/auth/login {phone, password, tenant_code, client_type?}
② LoginRateLimit 检查
③ AuthService.Login:
   a. 查 app.tenants WHERE code=tenant_code AND status=1
   b. 查 app.users WHERE tenant_id=? AND phone=? AND deleted_at IS NULL
   c. 用户不存在 → DummyVerify() → 1001
   d. Argon2id 校验密码
   e. 检查 status=1
   f. 生成 JTI，写 app.sessions（含 tenant_id, client_type）
   g. GenerateToken(uuid, jti) → 返回 Token + tenant 信息
```

**登录请求**：

```json
{
  "phone": "13800138000",
  "password": "xxx",
  "tenant_code": "acme",
  "client_type": "mobile"
}
```

`tenant_code` 用于区分用户所属公司。同一手机号在不同租户下可以是不同的用户。

### 7.3 鉴权中间件（双路径）

```
① 解析 Authorization: Bearer <token>
② ParseToken → payload, 验签
③ 判断 payload 前缀：
   ├── 无 "device:" 前缀 → 用户路径
   │   拆出 user_uuid, jti
   │   查 app.sessions WHERE jti=? AND expires_at > NOW()
   │   查 app.users WHERE uuid=? → status 校验
   │   注入 Context: user_id, user_uuid, role, tenant_id
   │
   └── "device:" 前缀 → 设备路径
       拆出 device_id, jti
       查 app.device_sessions WHERE jti=? AND expires_at > NOW()
       查 app.devices_terminal WHERE device_id=? → status 校验
       注入 Context: device_id, device_type, bound_user_id, tenant_id, scope="device"
```

### 7.4 多终端支持

所有用户终端（Web、手机 App、平板）共用同一套登录接口。`app.sessions.client_type` 记录终端类型，用于审计和管理。同一用户允许多终端同时在线。

### 7.5 终端设备鉴权（方案 B）

终端设备（RPi Zero 2W）采用「绑定账户」方案：设备预先配置凭证，开机自动认证，无需现场登录。

**设备凭证**：

| 项目 | 说明 |
|------|------|
| 身份标识 | `device_id`：管理员分配的唯一标识 |
| 认证密钥 | `device_secret`：创建时生成的 32 位随机字符串，仅返回一次 |
| 密钥存储 | 服务端存 `Argon2id(device_secret)` 哈希 |

**设备登录流程**：

```
① POST /api/device/auth {device_id, device_secret}
② DeviceAuthRateLimit
③ TerminalService.Authenticate:
   a. 查 app.devices_terminal WHERE device_id=? AND deleted_at IS NULL
   b. 不存在 → DummyVerify() → 6001
   c. Argon2id 校验
   d. status=1 校验
   e. bound_user_id IS NOT NULL 校验
   f. 写 app.device_sessions（TTL 24h，含 tenant_id）
   g. GenerateDeviceToken(device_id, jti) → 返回设备 Token
```

**设备会话**：TTL 24 小时，心跳可滑动续期；管理员禁用设备时立即清除所有设备会话。

### 7.6 退出与过期清理

- **用户退出**：`DELETE FROM app.sessions WHERE jti=?`
- **禁用用户**：`DELETE FROM app.sessions WHERE user_id=?`
- **禁用终端**：`DELETE FROM app.device_sessions WHERE device_id=?`
- **定时清理**：每小时清理 `sessions` 和 `device_sessions` 中过期行。

---

## 8. 核心业务：挑战-应答协议

### 8.1 用户侧：POST /api/lock/challenge

安全校验步骤：

| 步骤 | 校验 | 失败码 |
|------|------|--------|
| 1 | Auth 中间件通过，取 user_id + tenant_id | 401 |
| 2 | challenge_c 为 16 位 hex | 4001 |
| 3 | timestamp 与服务端差 ≤ 30s | 4002 |
| 4 | app.devices_lock WHERE tenant_id=? AND device_id=? 存在 | 3001 |
| 5 | status=1 | 3002 |
| 6 | 权限四路径查询（见数据库文档 5.7） | 2001 |
| 7 | 限流 | 3003 |
| 8 | KMS 解密 → 计算 Response | 5001 |

**权限查询**：不再仅查直接授权，而是通过四路径查询（用户直接、用户→设备组、用户组→设备、用户组→设备组）检查是否有任一有效路径。

### 8.2 POST /api/lock/report

```
result = "fail":
  → failStore.Increment(tenant_id, "lock", device_id)
  → count >= 3 → triggerAlertLock()
result = "success":
  → failStore.Reset(tenant_id, "lock", device_id)
→ PublishAudit（含 tenant_id）
```

### 8.3 GET /api/lock/devices

查询当前用户在当前租户下的授权设备列表（展开分组）：

```sql
SELECT DISTINCT dl.* FROM app.devices_lock dl
WHERE dl.tenant_id = ? AND dl.deleted_at IS NULL AND dl.status != 0
AND (
    -- 直接授权
    EXISTS (SELECT 1 FROM app.permissions p
        WHERE p.tenant_id = dl.tenant_id AND p.user_id = ? AND p.status = 1
        AND p.device_type = 'lock' AND p.device_id = dl.device_id
        AND p.valid_from <= NOW() AND (p.valid_until IS NULL OR p.valid_until > NOW()))
    OR
    -- 通过设备组授权
    EXISTS (SELECT 1 FROM app.permissions p
        JOIN app.device_group_members dgm ON dgm.group_id = p.device_group_id
        WHERE p.tenant_id = dl.tenant_id AND p.user_id = ? AND p.status = 1
        AND dgm.device_type = 'lock' AND dgm.device_id = dl.device_id
        AND p.valid_from <= NOW() AND (p.valid_until IS NULL OR p.valid_until > NOW()))
    OR
    -- 通过用户组授权
    EXISTS (SELECT 1 FROM app.permissions p
        JOIN app.user_group_members ugm ON ugm.group_id = p.user_group_id
        WHERE p.tenant_id = dl.tenant_id AND ugm.user_id = ? AND p.status = 1
        AND p.device_type = 'lock' AND p.device_id = dl.device_id
        AND p.valid_from <= NOW() AND (p.valid_until IS NULL OR p.valid_until > NOW()))
    OR
    -- 通过用户组+设备组授权
    EXISTS (SELECT 1 FROM app.permissions p
        JOIN app.user_group_members ugm ON ugm.group_id = p.user_group_id
        JOIN app.device_group_members dgm ON dgm.group_id = p.device_group_id
        WHERE p.tenant_id = dl.tenant_id AND ugm.user_id = ? AND p.status = 1
        AND dgm.device_type = 'lock' AND dgm.device_id = dl.device_id
        AND p.valid_from <= NOW() AND (p.valid_until IS NULL OR p.valid_until > NOW()))
)
```

### 8.4 终端侧挑战-应答流程

终端设备（RPi Zero 2W）作为备用 NFC 终端，人在现场使用。流程与用户侧一致，但鉴权和权限校验不同。

**核心差异**：

| 维度 | 用户侧（手机/Web） | 终端侧（RPi） |
|------|-------------------|---------------|
| 鉴权主体 | 用户 Token → user_id | 设备 Token → device_id |
| 权限校验 | `app.permissions` 四路径 | `app.terminal_lock_bindings` |
| 审计 user_id | 当前用户 | 终端的 bound_user_id |
| 操作场景 | 手机 NFC | 备用终端 NFC（手机不可用时） |

**POST /api/device/lock/challenge**：

```
① DeviceAuth 中间件通过，取 device_id + tenant_id + bound_user_id
② 请求体：{lock_device_id, challenge_c, timestamp}
③ 参数校验 + 时间戳校验
④ 查 devices_terminal status=1
⑤ 查 terminal_lock_bindings（支持直接绑定和设备组绑定两条路径）
   未找到 → 6003
⑥ 查 devices_lock status=1
⑦ KMS 解密 → 计算 Response → 清空 K_d
→ 返回 {"response": "hex_string"}
→ 审计：user_id=bound_user_id, extra={"via":"terminal","terminal_id":"..."}
```

**POST /api/device/heartbeat**：

```json
POST /api/device/heartbeat
{
  "firmware_version": "1.2.0",
  "uptime_seconds": 86400
}
```

服务端处理：
- 更新 `devices_terminal.last_active_at`
- 可选刷新 device_session 续期
- 检查 `target_firmware`，若存在且不同于上报版本，返回 OTA 信息：

```json
{
  "status": "ok",
  "server_time": 1708300000,
  "ota": {
    "target_version": "1.3.0",
    "download_url": "https://...",
    "checksum_sha256": "..."
  }
}
```

---

## 9. 管理后台业务

**所有管理操作均在租户范围内执行**，Service 层自动注入 `tenant_id` 条件。

### 9.1 用户管理

| 操作 | 说明 |
|------|------|
| 创建 | tenant_admin/admin 创建用户 → 生成随机密码 → 归属当前租户 → 检查租户配额 |
| 更新 | name/department/role/status；status=0 时清除该用户所有 sessions |
| 重置密码 | 新随机密码返回页面，管理员告知用户 |
| 列表 | 仅展示当前租户的用户，支持 role/status/search 筛选 |

**角色管理约束**：
- `tenant_admin` 可创建任意角色的用户
- `admin` 只能创建/管理 `operator` 角色
- 任何人不能修改或删除自己的账号

### 9.2 设备管理（锁具）

| 操作 | 说明 |
|------|------|
| 创建 | device_key(hex) → KMS 加密 → 写 devices_lock（tenant_id=当前租户）→ 检查配额 |
| 列表 | 仅当前租户，支持 status/pipeline_tag/search 筛选 |

### 9.3 设备分组管理

| 操作 | 说明 |
|------|------|
| 创建分组 | `{name, description}` → 名称租户内唯一 |
| 添加成员 | `{device_type, device_id}` → 校验设备属于当前租户 |
| 移除成员 | 按成员 ID 删除 |
| 列表 | 含各组成员数统计 |

### 9.4 用户分组管理

| 操作 | 说明 |
|------|------|
| 创建分组 | `{name, description}` → 名称租户内唯一 |
| 添加成员 | `{user_id}` → 校验用户属于当前租户 |
| 移除成员 | 按成员 ID 删除 |
| 列表 | 含各组成员数统计 |

### 9.5 权限管理

支持四种授权组合：

| 操作 | 说明 |
|------|------|
| 授权 | `{subject_type, subject_id, object_type, object_id, valid_from, valid_until}` → subject_type 为 `user` 或 `user_group`，object_type 为 `device` 或 `device_group` → 查已有有效授权：有则更新有效期，无则新建 |
| 批量授权 | 循环调用（≤100 条） |
| 撤销 | UPDATE status=0 + revoked_by/at |
| 列表 | 支持按主体/客体类型和 ID 筛选 |

**示例**：将「巡检队A」用户组授权操作「油田A阀门组」设备组：

```json
POST /api/admin/permissions
{
  "subject_type": "user_group",
  "subject_id": 5,
  "object_type": "device_group",
  "object_id": 3,
  "valid_from": "2026-03-01T00:00:00Z",
  "valid_until": "2026-12-31T23:59:59Z"
}
```

### 9.6 终端设备管理

| 操作 | 说明 |
|------|------|
| 创建 | 系统生成 device_secret → Argon2id 哈希 → 写 devices_terminal（status=0）→ **secret 仅此次返回** |
| 绑定 | 将终端绑定到当前管理员：`bound_user_id = 当前用户`，status → 1 |
| 更新 | name/status；status=3 时清除所有 device_sessions |
| 重置密钥 | 新 secret → 哈希 → 更新 → 清除 sessions → 返回新 secret |
| 列表 | 支持 status/device_model/bound_user_id 筛选 |

**终端配置流程**：

```
① 后台创建终端 → 拿到 device_id + device_secret
② 物理配置：写入 RPi 配置文件
③ 后台绑定终端到管理员
④ 后台创建终端-锁具绑定（支持绑定设备组）
⑤ RPi 上电 → 自动认证 → 心跳 → 可执行挑战
```

### 9.7 终端授权管理

| 操作 | 说明 |
|------|------|
| 绑定到锁具 | `{terminal_id, lock_device_id, valid_from, valid_until}` |
| 绑定到设备组 | `{terminal_id, device_group_id, valid_from, valid_until}` |
| 批量绑定 | ≤50 条 |
| 撤销 | UPDATE status=0 |
| 列表 | 支持 terminal_id / lock_device_id 筛选 |

### 9.8 OTA 更新管理

| 操作 | 说明 |
|------|------|
| 上传固件包 | `{version, device_model, download_url, checksum_sha256, release_notes}` → 写 ota_packages |
| 下发更新 | 选择目标终端或全部 → 更新 `devices_terminal.target_firmware` → 终端心跳时自动发现 |

### 9.9 告警管理

| 操作 | 说明 |
|------|------|
| 列表 | 当前租户内，支持 status/device_id/severity 筛选 |
| 处置 | handle_note → status=1；可选解除设备锁定 |

### 9.10 审计日志

- 查 `log.audit_logs WHERE tenant_id=?`，支持 user_id/device_id/action/时间范围。
- 游标分页。

### 9.11 Dashboard

并发查询（当前租户范围内）：
- 活跃用户数、设备总数、终端设备数
- 活跃 Session 数
- 待处置告警数 + 最近 10 条
- 设备按 status 分组计数
- 用户分组 / 设备分组数量

### 9.12 操作日志

所有管理操作通过 `logOperation(tenantID, operatorID, action, targetType, targetID, before, after)` 写入 `log.operation_logs`。

---

## 10. 消息队列

### 10.1 队列规划

| 队列 | 类型 | 说明 |
|------|------|------|
| `audit.queue` | Durable | 开锁审计日志 |
| `notify.queue` | Durable | 告警通知推送 |
| `audit.dlq` | Durable | 审计死信 |
| `notify.dlq` | Durable | 通知死信 |

### 10.2 消息结构

**AuditMessage** 新增 `tenant_id` 字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| tenant_id | int64 | 租户 ID |
| user_id | int64 | |
| device_id | string | |
| device_type | string | |
| action | string | challenge_request / unlock_success / unlock_fail |
| extra | map | 含 `via`（"user"/"terminal"）、`terminal_id` 等 |

### 10.3 审计消费者

批量写入 `log.audit_logs`（含 `tenant_id`），缓冲区 100 条或 1 秒触发 flush。

---

## 11. 安全设计

### 11.0 密钥与 Token 总览

| 用途 | 密钥 | 模块 | 说明 |
|------|------|------|------|
| 设备/锁具 | 主密钥 + K_d | KMS | 挑战-应答 |
| 用户/终端 Token | AUTH_TOKEN_SECRET | middleware | Token 签名 |
| 终端设备密钥 | device_secret | Argon2id 哈希存库 | 终端认证 |

### 11.1 KMS 与设备密钥

与 V1.x 一致：`EncryptDeviceKey` / `DecryptDeviceKey` / `ComputeCMAC`，主密钥仅存进程内存。

### 11.2 密码安全

- Argon2id，参数 m=65536(64MB)、t=3、p=4、salt=16B、key=32B。
- DummyVerify 防时序攻击。
- GenerateRandomPassword(16) 用 crypto/rand。

### 11.3 租户隔离安全

| 层次 | 措施 |
|------|------|
| **中间件** | Auth 中间件从 Session 提取 tenant_id，注入 Context |
| **Service** | 所有查询自动 WHERE tenant_id=?，禁止客户端传入 |
| **数据库** | 唯一索引含 tenant_id，物理上保证跨租户不冲突 |
| **API** | 响应中不暴露其他租户的任何数据 |

### 11.4 传输安全头

```
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Content-Security-Policy: default-src 'self'; ...
Strict-Transport-Security: max-age=31536000; includeSubDomains
```

### 11.5 敏感数据

| 数据 | 处理 |
|------|------|
| 手机号 | API 响应中脱敏为 `138****8888` |
| 密码 | Argon2id 哈希，不返回 |
| K_d | KMS 加密存储，用后置零 |
| device_secret | Argon2id 哈希，仅创建时返回一次 |
| Token secret | 环境变量传入 |

---

## 12. 日志与可观测性

### 12.1 结构化日志

所有日志包含 `request_id`（链路追踪）和 `tenant_id`（租户标识）。

| 级别 | 场景 |
|------|------|
| DEBUG | GORM SQL、中间变量 |
| INFO | 业务关键状态 |
| WARN | 安全告警（连续失败、设备锁定） |
| ERROR | DB 失败、KMS 异常 |
| FATAL | 启动失败 |

### 12.2 业务流程状态日志

#### 认证模块

| 日志点 | 级别 | 关键字段 |
|--------|------|---------|
| `login: attempt` | INFO | phone, tenant_code, ip |
| `login: failed, *reason*` | INFO | phone, tenant_code |
| `login: success` | INFO | user_id, tenant_id, role |
| `device_auth: attempt` | INFO | device_id, ip |
| `device_auth: failed, *reason*` | INFO | device_id |
| `device_auth: success` | INFO | device_id, tenant_id, bound_user_id |

#### 挑战-应答模块

| 日志点 | 级别 | 关键字段 |
|--------|------|---------|
| `challenge: start` | INFO | tenant_id, user_id, device_id |
| `challenge: rejected, *reason*` | INFO | + 拒绝原因 |
| `challenge: success` | INFO | tenant_id, user_id, device_id |
| `terminal_challenge: start` | INFO | tenant_id, terminal_id, lock_device_id |
| `terminal_challenge: success` | INFO | tenant_id, terminal_id, lock_device_id |
| `report: consecutive fail threshold` | **WARN** | device_id, fail_count |

#### 管理后台模块

| 日志点 | 级别 | 关键字段 |
|--------|------|---------|
| `create_user/device/group: success` | INFO | tenant_id, operator_id, target_id |
| `grant_permission: success` | INFO | tenant_id, subject_type, object_type |
| `create_terminal: success` | INFO | tenant_id, device_id, operator_id |
| `bind_terminal: success` | INFO | tenant_id, device_id, bound_user_id |
| `ota_deploy: success` | INFO | tenant_id, target_version, device_count |

#### 命名规范

- 格式：`模块名: 状态描述`
- 安全事件使用 **WARN**

### 12.3 Prometheus 指标

| 指标名 | 类型 | 说明 |
|--------|------|------|
| `http_request_duration_seconds` | Histogram | 按 method/path/status |
| `lock_challenge_total` | Counter | 按 result, tenant_id |
| `active_sessions_total` | Gauge | |
| `db_pool_open_connections` | Gauge | |
| `mq_queue_depth` | Gauge | |

---

## 13. 统一响应与错误码

### 13.1 响应信封

```go
type Response struct {
    Code      int         `json:"code"`
    Message   string      `json:"message"`
    Data      interface{} `json:"data"`
    RequestID string      `json:"request_id"`
    Timestamp int64       `json:"timestamp"`
}
```

### 13.2 错误码体系

| 范围 | 类型 | 当前定义 |
|------|------|---------|
| 1xxx | 认证 | 1001 登录失败、1002 账号禁用、1003 会话过期、1004 租户不存在/已停用 |
| 2xxx | 权限 | 2001 无操作权限、2002 访问拒绝、2003 角色不足 |
| 3xxx | 锁具 | 3001 设备不存在、3002 设备不可用、3003 请求过频 |
| 4xxx | 参数 | 4001 参数错误、4002 请求过期 |
| 5xxx | 内部 | 5001 服务内部错误 |
| 6xxx | 终端 | 6001 终端认证失败、6002 终端未激活/已禁用、6003 终端无此锁具授权、6004 终端未绑定、6005 终端不存在 |
| 7xxx | 分组/租户 | 7001 分组不存在、7002 分组名已存在、7003 超出租户配额、7004 跨租户操作被拒绝 |

### 13.3 HTTP 状态码映射

```
1xxx → 401    2xxx → 403    3xxx → 400 (3003→429)
4xxx → 400    5xxx → 500    6xxx → 401/403
7xxx → 400/403/409
```

---

## 14. 数据访问层

### 14.1 全局 DB 实例

`repository.DB` 全局 `*gorm.DB`，含连接池。关键配置：`SkipDefaultTransaction: true`、`PrepareStmt: true`。

### 14.2 Store 接口

```go
type SessionStore interface {
    Create(*Session) error
    FindByJTI(uuid.UUID) (*Session, error)
    DeleteByJTI(uuid.UUID) error
    DeleteByUserID(int64) error
    CleanExpired() (int64, error)
    CountActive() (int64, error)
    CountActiveByTenant(tenantID int64) (int64, error)
}

type DeviceSessionStore interface {
    Create(*DeviceSession) error
    FindByJTI(uuid.UUID) (*DeviceSession, error)
    DeleteByJTI(uuid.UUID) error
    DeleteByDeviceID(deviceID string) error
    CleanExpired() (int64, error)
    RefreshExpiry(jti uuid.UUID, newExpiry time.Time) error
}

type DeviceFailStore interface {
    Increment(tenantID int64, deviceType, deviceID string) (int, error)
    Reset(tenantID int64, deviceType, deviceID string) error
    Get(tenantID int64, deviceType, deviceID string) (int, error)
}
```

### 14.3 事务封装

```go
repository.Transaction(fn func(tx *gorm.DB) error) error
repository.RetryTransaction(maxRetries int, fn) error
```

### 14.4 Schema 约定

| Model | TableName |
|-------|-----------|
| Tenant | `app.tenants` |
| User | `app.users` |
| Session | `app.sessions` |
| DeviceLock | `app.devices_lock` |
| DeviceTerminal | `app.devices_terminal` |
| DeviceSession | `app.device_sessions` |
| DeviceGroup | `app.device_groups` |
| DeviceGroupMember | `app.device_group_members` |
| UserGroup | `app.user_groups` |
| UserGroupMember | `app.user_group_members` |
| Permission | `app.permissions` |
| TerminalLockBinding | `app.terminal_lock_bindings` |
| Alert | `app.alerts` |
| RateLimit | `app.rate_limits` |
| DeviceFailCount | `app.device_fail_counts` |
| IPBlock | `app.ip_blocks` |
| OTAPackage | `app.ota_packages` |
| AuditLog | `log.audit_logs` |
| OperationLog | `log.operation_logs` |

---

## 15. 构建与部署

### 15.1 Dockerfile（多阶段）

```
阶段 1 — builder（golang:1.22-alpine）:
  GOPROXY=https://goproxy.cn,direct
  CGO_ENABLED=0 → 静态编译 → /lock-service

阶段 2 — runtime（alpine:3.19）:
  ca-certificates + tzdata（Asia/Shanghai）
  COPY /lock-service + /migrations
  EXPOSE 8080
  ENTRYPOINT ["/lock-service"]
```

### 15.2 构建参数

| 参数 | 说明 |
|------|------|
| `GOARCH` | 默认 arm64（树莓派）；x86 改为 amd64 |
| `HTTP_PROXY` / `HTTPS_PROXY` | docker-compose build.args |

### 15.3 健康检查

`GET /api/health` → Ping 数据库 → 返回 `{"status": "healthy"}`。

---

## 16. 版本记录

| 版本 | 日期 | 变更说明 |
|------|------|---------|
| V1.0 | 2026-02-20 | 初版，从 Web 端文档剥离。 |
| V1.1 | 2026-02-20 | 密码重置改页面返回；新增业务日志章节。 |
| V1.2 | 2026-02-20 | 密钥与 Token 总览；设备密钥流程补充。 |
| V1.3 | 2026-02-20 | 设计决策说明补充。 |
| V1.4 | 2026-02-23 | 网关设备设计（后被 V2.0 替代）。 |
| V2.0 | 2026-02-23 | **架构重构**：① 多租户隔离（tenants + 全表 tenant_id + TenantScope 中间件 + 租户级配额）；② 角色层级（tenant_admin / admin / operator）；③ 登录流程增加 tenant_code；④ 设备分组 + 用户分组（device_groups / user_groups + members）；⑤ 权限 4-way 改造（用户/用户组 × 设备/设备组）；⑥ 终端设备方案 B（gateway 重命名为 terminal，绑定账户，开机即用）；⑦ 终端授权支持绑定设备组；⑧ OTA 固件更新（ota_packages + target_firmware + 心跳下发）；⑨ 全部路由/Service/Model/日志/审计增加租户维度；⑩ 7xxx 分组/租户错误码。 |

---

> ※ 本文档为服务端专项设计基准，后续模块变更须同步更新并记录变更历史。
