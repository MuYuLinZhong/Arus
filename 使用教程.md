# Promthus 管控平台 · 使用教程

本文说明在树莓派上部署完成后，如何从你的 PC 浏览器访问各个服务、登录管控平台并完成常用操作。

---

## 一、访问地址总览

部署完成后，树莓派会对外提供以下访问入口（将 `<PI_IP>` 替换为树莓派实际局域网 IP，例如 `192.168.0.200`）：

| 服务 | 访问地址 | 说明 |
|------|----------|------|
| **管控平台（主应用）** | `http://<PI_IP>` | 前端页面 + 后端 API，日常使用入口 |
| **RabbitMQ 管理界面** | `http://<PI_IP>:15672` | 消息队列管理（可选，运维用） |

其他服务（PostgreSQL 5432、RabbitMQ AMQP 5672、Go 服务 8080）不直接对浏览器开放，由 Nginx 统一从 80 端口接入。

---

## 二、打开管控平台

1. 确保你的 PC 与树莓派在同一局域网，且已用《树莓派部署指南》完成部署并启动服务。
2. 在 PC 上打开浏览器（Chrome、Edge、Safari 等均可）。
3. 在地址栏输入：
   ```text
   http://<PI_IP>
   ```
   例如：`http://192.168.0.200`
4. 回车后应看到 **登录页**（手机号 + 密码）。

若无法打开页面，请检查：
- 树莓派是否已开机、服务是否已启动（`docker compose -f docker-compose.pi.yml ps` 均为 Up）。
- PC 与树莓派是否在同一网段，能否 ping 通 `<PI_IP>`。

---

## 三、登录

1. 在登录页输入 **手机号** 和 **密码**。
2. 点击「登录」。

**默认管理员账号（首次部署）：**

- **手机号**：`13800000000`（来自数据库初始化脚本）
- **密码**：以《树莓派部署指南》或项目迁移脚本说明为准；若脚本中为占位哈希，需先在数据库中写入真实密码哈希后再用该账号登录。

登录成功后会自动跳转到 **总览（仪表盘）** 页面。

---

## 四、主要功能与页面

登录后，左侧为导航菜单，右侧为内容区。以下为各页面的用途与基本操作。

### 1. 总览（仪表盘）

- **路径**：`http://<PI_IP>/` 或 `http://<PI_IP>/dashboard`
- **说明**：展示系统概览数据（用户数、设备数、告警统计等）。
- **操作**：仅查看，无额外操作。

### 2. 用户管理

- **路径**：`http://<PI_IP>/users`
- **说明**：管理系统用户（管理员/普通用户）、状态（启用/禁用）。
- **常用操作**：
  - 列表筛选：按角色、状态、关键词搜索。
  - 新增用户：填写手机号、姓名、部门、角色、密码等。
  - 编辑/禁用：在列表中操作对应用户。

### 3. 锁具管理（设备管理）

- **路径**：`http://<PI_IP>/devices`
- **说明**：管理 NFC 锁具设备：录入设备、查看状态、编辑信息。
- **常用操作**：
  - 新增设备：填写设备 ID、名称、位置、密钥等（密钥为 16 进制 AES-128）。
  - 按设备 ID/名称搜索、按状态筛选。
  - 查看设备在线状态、最后活跃时间。

### 4. 权限管理

- **路径**：`http://<PI_IP>/permissions`
- **说明**：配置「用户 – 设备」的开门权限及有效期。
- **常用操作**：
  - 授予权限：选择用户、设备、有效期（起止时间）。
  - 撤销权限：在列表中操作「撤销」。
  - 按用户、设备、状态筛选查看。

### 5. 审计日志

- **路径**：`http://<PI_IP>/audit-logs`
- **说明**：查看系统操作与开门等审计记录。
- **常用操作**：按时间、设备 ID、操作类型等筛选、导出或翻页查看。

### 6. 告警管理

- **路径**：`http://<PI_IP>/alerts`
- **说明**：查看设备相关告警（如非法开门、异常等）并做处置。
- **常用操作**：按状态、级别、设备筛选；对告警进行「处置」并填写处置说明。

### 7. 无权限时

- 若当前账号无某菜单权限，会跳转到 **403 无权限** 页面（`http://<PI_IP>/403`）。
- 仅具有相应角色（如 admin）的账号可访问上述管理页面。

---

## 五、RabbitMQ 管理界面（可选）

用于查看消息队列、队列堆积、连接数等，供运维排查问题使用。

1. 浏览器打开：
   ```text
   http://<PI_IP>:15672
   ```
2. 使用 `.env` 中配置的 RabbitMQ 账号登录：
   - 用户名：与 `RABBITMQ_USER` 一致（如 `promthus`）
   - 密码：与 `RABBITMQ_PASS` 一致

登录后可查看 Queues、Connections、Channels 等。

---

## 六、退出登录

在管控平台页面中，点击右上角用户信息或「退出」按钮即可退出当前账号，退出后会回到登录页。

---

## 七、常见问题

**Q：输入 http://<PI_IP> 后一直转圈或打不开？**  
- 确认树莓派上服务已启动：`docker compose -f docker-compose.pi.yml ps` 中 nginx、lock-service 等均为 Up。  
- 确认 PC 能 ping 通树莓派 IP。

**Q：登录时提示「用户名或密码错误」？**  
- 确认使用的是「手机号」登录，不是用户名。  
- 默认管理员手机号为 `13800000000`；若迁移脚本中密码为占位符，需在数据库中更新为真实密码哈希后再登录。

**Q：登录后看不到菜单或部分页面 403？**  
- 当前账号角色可能不是 admin；仅 admin 角色可访问用户/设备/权限/审计/告警等管理页。使用管理员账号登录即可。

**Q：如何修改管理员密码？**  
- 若有「用户管理」权限，可在「用户管理」中编辑对应用户并修改密码。  
- 或通过数据库连接树莓派上的 PostgreSQL，更新对应用户的 `password_hash` 字段（需使用 Argon2id 哈希）。

---

## 八、快速链接汇总

| 操作 | 链接示例 |
|------|----------|
| 打开管控平台 | `http://192.168.0.200` |
| 总览 | `http://192.168.0.200/dashboard` |
| 用户管理 | `http://192.168.0.200/users` |
| 锁具管理 | `http://192.168.0.200/devices` |
| 权限管理 | `http://192.168.0.200/permissions` |
| 审计日志 | `http://192.168.0.200/audit-logs` |
| 告警管理 | `http://192.168.0.200/alerts` |
| RabbitMQ 管理 | `http://192.168.0.200:15672` |

将 `192.168.0.200` 替换为你树莓派的实际 IP 即可。
