# 开发纪要

**防盗安全预警系列 · 石油阀门 NFC 智能管控系统**

| 项目 | 内容 |
|------|------|
| 纪要版本 | V1.0 |
| 生成日期 | 2026-02-19 |
| 依据文档 | 技术设计说明书 V1.0 |
| 状态 | 初始骨架搭建完成 |

---

## 1. 项目总览

本次开发基于《Web 端技术设计说明书 V1.0》，完成了系统的完整代码骨架搭建，涵盖 Go 服务端、Vue 3 前端管控平台、Docker Compose 部署编排三大部分。

### 1.1 技术栈确认

| 层面 | 技术选型 | 版本 |
|------|---------|------|
| 服务端框架 | Go + Gin | Go 1.22 / Gin 1.9 |
| 数据库 | PostgreSQL | 15 |
| ORM | GORM + pgx 驱动 | GORM 1.25 |
| 消息队列 | RabbitMQ | 3.13 |
| 前端框架 | Vue 3 + TypeScript + Vite | Vue 3.4 / Vite 5.2 |
| UI 组件库 | Ant Design Vue | 4.1 |
| 状态管理 | Pinia | 2.1 |
| 图表 | ECharts | 5.5 |
| 日志 | Zap (结构化 JSON) | 1.27 |
| 监控 | Prometheus + Grafana + Loki | — |
| 容器化 | Docker Compose | 3.8 |

---

## 2. 已完成模块清单

### 2.1 后端（Go 服务端）

| 模块 | 文件路径 | 完成状态 | 说明 |
|------|---------|---------|------|
| **配置管理** | `server/internal/config/config.go` | ✅ 完成 | 环境变量驱动，支持全部配置项 |
| **数据模型** | `server/internal/model/models.go` | ✅ 完成 | 9 张表全部定义：users, sessions, devices, permissions, audit_logs, rate_limits, alerts, operation_logs, device_fail_counts, ip_blocks |
| **统一响应** | `server/internal/model/response.go` | ✅ 完成 | 统一 `{code, message, data, request_id, timestamp}` 格式，业务错误码 1xxx~5xxx |
| **数据库初始化** | `server/internal/repository/database.go` | ✅ 完成 | GORM 连接池配置，启动 Ping 检查，事务封装 |
| **Session 存储** | `server/internal/repository/session_store.go` | ✅ 完成 | `SessionStore` 接口抽象 + PostgreSQL 实现，为 Redis 迁移预留 |
| **设备失败计数** | `server/internal/repository/session_store.go` | ✅ 完成 | `DeviceFailStore` 接口 + PostgreSQL Upsert 实现 |
| **日志系统** | `server/internal/logger/logger.go` | ✅ 完成 | Zap 结构化日志，开发/生产双模式 |
| **中间件链** | `server/internal/middleware/` | ✅ 完成 | Recovery → RequestID → SecurityHeaders → CORS → AccessLog → RateLimit → Auth → RBAC |
| **Token 机制** | `server/internal/middleware/auth.go` + `hmac.go` | ✅ 完成 | HMAC-SHA256 签名，payload = userUUID:jti |
| **限流控制** | `server/internal/middleware/ratelimit.go` | ✅ 完成 | PostgreSQL Upsert 原子限流，支持登录/挑战/全局三种策略 |
| **密码安全** | `server/internal/crypto/argon2.go` | ✅ 完成 | Argon2id (64MB/3次/4线程)，DummyVerify 防时序攻击 |
| **AES 加密** | `server/internal/crypto/aes.go` | ✅ 完成 | AES-256-GCM 加解密 + 手机号脱敏 |
| **KMS 密钥管理** | `server/internal/kms/kms.go` | ✅ 完成 | 本地 KMS 实现，AES-256-GCM 加密设备密钥，AES-128-CMAC 计算 |
| **Auth Service** | `server/internal/service/auth_service.go` | ✅ 完成 | 登录（8步校验）、登出、Session 创建 |
| **Lock Service** | `server/internal/service/lock_service.go` | ✅ 完成 | 挑战-应答（8步安全校验）、结果上报（含告警触发）、授权设备列表 |
| **Admin Service** | `server/internal/service/admin_service.go` | ✅ 完成 | 用户 CRUD、设备管理、权限授权/撤销（Upsert 幂等）、告警处置、Dashboard、审计日志查询 |
| **MQ Publisher** | `server/internal/mq/publisher.go` | ✅ 完成 | RabbitMQ 消息发布，audit.queue + notify.queue |
| **Audit Consumer** | `server/internal/mq/consumer.go` | ✅ 完成 | 批量消费审计消息，100条/1秒 批量写入 |
| **Handler 层** | `server/internal/handler/` | ✅ 完成 | auth/lock/admin/health 四组 Handler |
| **路由配置** | `server/internal/router/router.go` | ✅ 完成 | 全部 17 个 API 端点路由注册 |
| **Prometheus 指标** | `server/internal/metrics/prometheus.go` | ✅ 完成 | 5 个核心指标 + 中间件自动采集 |
| **主入口** | `server/cmd/main.go` | ✅ 完成 | 优雅启停、Session 定时清理、RabbitMQ 可选连接 |
| **数据库迁移** | `server/migrations/001_init.sql` | ✅ 完成 | 全部表结构 + 索引 + 分区表 + 初始管理员 |

### 2.2 前端（Vue 3 管控平台）

| 模块 | 文件路径 | 完成状态 | 说明 |
|------|---------|---------|------|
| **项目配置** | `web/package.json` + `vite.config.ts` | ✅ 完成 | Vite 5 + 开发代理 |
| **类型定义** | `web/src/types/index.ts` | ✅ 完成 | 全部 API 数据类型 |
| **HTTP 封装** | `web/src/utils/request.ts` | ✅ 完成 | Axios 拦截器，自动 Token 注入，统一错误处理，会话过期自动跳转 |
| **API 模块** | `web/src/api/` | ✅ 完成 | auth.ts / admin.ts / lock.ts 三个模块 |
| **状态管理** | `web/src/stores/` | ✅ 完成 | auth store（登录态）+ alert store（告警轮询） |
| **路由守卫** | `web/src/router/index.ts` | ✅ 完成 | 鉴权检查 + RBAC 角色校验 + 登录态重定向 |
| **Composables** | `web/src/composables/` | ✅ 完成 | useAlertPolling（30秒轮询）+ usePagedList（游标分页） |
| **格式化工具** | `web/src/utils/format.ts` | ✅ 完成 | 时间格式化、手机号脱敏、状态/级别/类型映射 |
| **登录页** | `web/src/views/Login.vue` | ✅ 完成 | 深色渐变背景 + 表单校验 |
| **布局框架** | `web/src/views/Layout.vue` | ✅ 完成 | 侧边栏导航 + 告警徽标 + 用户菜单 |
| **Dashboard** | `web/src/views/Dashboard.vue` | ✅ 完成 | 4 个统计卡片 + ECharts 饼图 + 最新告警表格 |
| **用户管理** | `web/src/views/Users.vue` | ✅ 完成 | 列表/搜索/筛选 + 新建/编辑/禁用/重置密码 |
| **锁具管理** | `web/src/views/Devices.vue` | ✅ 完成 | 列表/搜索/筛选 + 添加锁具（含 K_d 上传） |
| **权限管理** | `web/src/views/Permissions.vue` | ✅ 完成 | 授权/撤销 + 状态筛选 |
| **审计日志** | `web/src/views/AuditLogs.vue` | ✅ 完成 | 游标分页「加载更多」+ 多维筛选 + 失败行高亮 |
| **告警管理** | `web/src/views/Alerts.vue` | ✅ 完成 | 列表/筛选 + 处置弹窗（含解除设备锁定） |
| **通用组件** | `web/src/components/` | ✅ 完成 | DeviceStatusBadge / AlertSeverityTag |

### 2.3 部署与基础设施

| 模块 | 文件路径 | 完成状态 | 说明 |
|------|---------|---------|------|
| **Docker Compose** | `docker-compose.yml` | ✅ 完成 | 7 个服务：PostgreSQL + RabbitMQ + 2×Go + Nginx + Prometheus + Loki + Grafana |
| **Dockerfile** | `server/Dockerfile` | ✅ 完成 | 多阶段构建，Alpine 基础镜像，约 20MB |
| **Nginx 配置** | `deploy/nginx/nginx.conf` | ✅ 完成 | 反向代理 + 负载均衡 + SPA 回退 + 安全头 + Gzip |
| **Prometheus 配置** | `deploy/prometheus.yml` | ✅ 完成 | 双实例指标采集 |
| **环境变量模板** | `.env.example` | ✅ 完成 | 数据库/MQ/Token/Grafana 密码 |

---

## 3. 架构设计决策记录

### 3.1 Session 方案：数据库 vs JWT

**决策**：采用 PostgreSQL 数据库存储 Session，不使用 JWT 无状态方案。

**原因**：
- 系统安全要求管理员禁用用户后**立即**失效所有会话
- JWT 无法主动吊销（需额外维护黑名单，等于变相引入了有状态存储）
- 初期流量下 PostgreSQL 完全可以承载 Session 查询

**扩展路径**：通过 `SessionStore` 接口抽象，后续可无缝切换到 Redis 实现。

### 3.2 限流方案：PostgreSQL Upsert

**决策**：使用 PostgreSQL `rate_limits` 表 + Upsert 原子操作实现限流。

**原因**：
- 避免初期引入 Redis 增加运维复杂度
- PostgreSQL 行级锁保证计数器原子性，不存在并发计数不准确问题
- 同样通过接口抽象，后续可迁移到 Redis

### 3.3 审计日志：异步写入

**决策**：主流程通过 RabbitMQ 异步投递审计消息，Consumer 批量写入。

**原因**：
- 主流程响应时间不受数据库写入压力影响
- 峰值时消息队列自然削峰
- 批量写入（100条/批 或 1秒/次）大幅提升写入效率

### 3.4 密钥管理：本地 KMS

**决策**：初期使用本地 KMS 实现（AES-256-GCM 加密设备密钥），预留阿里云 KMS / Vault 接口。

**原因**：
- 开发阶段无需外部 KMS 依赖
- `KMS` 接口已抽象，切换实现只需修改依赖注入

### 3.5 分页方案：游标分页

**决策**：所有列表接口使用游标分页（Keyset Pagination），不使用 OFFSET。

**原因**：
- OFFSET 在大数据量下性能随页数线性下降
- 游标分页性能恒定，适合审计日志等大表
- 前端采用「加载更多」模式，不支持跳页（可接受的限制）

---

## 4. 项目目录结构

```
Promthus/
├── 设计大纲.md                    # 技术设计说明书
├── 开发纪要.md                    # 本文档
├── docker-compose.yml             # Docker Compose 编排
├── .env.example                   # 环境变量模板
├── .gitignore
│
├── server/                        # Go 服务端
│   ├── cmd/main.go               # 主入口
│   ├── Dockerfile
│   ├── go.mod
│   ├── migrations/               # 数据库迁移脚本
│   │   └── 001_init.sql
│   └── internal/
│       ├── config/               # 配置管理
│       ├── middleware/           # 中间件（Recovery/RequestID/Auth/RBAC/RateLimit/Security）
│       ├── model/               # 数据模型 + 统一响应
│       ├── repository/          # 数据访问层（接口抽象 + PostgreSQL 实现）
│       ├── service/             # 业务逻辑层（Auth/Lock/Admin）
│       ├── handler/             # HTTP Handler 层
│       ├── router/              # 路由配置
│       ├── mq/                  # RabbitMQ Publisher + Consumer
│       ├── kms/                 # 密钥管理服务
│       ├── crypto/              # 加密工具（Argon2id/AES）
│       ├── logger/              # Zap 日志
│       └── metrics/             # Prometheus 指标
│
├── web/                          # Vue 3 前端
│   ├── package.json
│   ├── vite.config.ts
│   ├── index.html
│   └── src/
│       ├── main.ts
│       ├── App.vue
│       ├── api/                 # 接口封装（auth/admin/lock）
│       ├── stores/              # Pinia 状态管理（auth/alert）
│       ├── views/               # 页面组件（7个页面）
│       ├── components/          # 通用组件
│       ├── composables/         # 可复用逻辑 Hook
│       ├── router/              # 路由 + 守卫
│       ├── utils/               # 工具函数
│       └── types/               # TypeScript 类型
│
└── deploy/                       # 部署配置
    ├── nginx/nginx.conf
    ├── prometheus.yml
    └── docker/
```

---

## 5. API 接口实现对照表

| 设计文档接口 | 方法 | 路径 | 实现状态 |
|------------|------|------|---------|
| 用户登录 | POST | `/api/auth/login` | ✅ |
| 退出登录 | POST | `/api/auth/logout` | ✅ |
| 获取授权设备列表 | GET | `/api/lock/devices` | ✅ |
| 提交挑战数 | POST | `/api/lock/challenge` | ✅ |
| 上报开锁结果 | POST | `/api/lock/report` | ✅ |
| 用户列表 | GET | `/api/admin/users` | ✅ |
| 创建用户 | POST | `/api/admin/users` | ✅ |
| 更新用户 | PUT | `/api/admin/users/:uuid` | ✅ |
| 重置密码 | POST | `/api/admin/users/:uuid/reset-pwd` | ✅ |
| 锁具列表 | GET | `/api/admin/devices` | ✅ |
| 创建锁具 | POST | `/api/admin/devices` | ✅ |
| 权限授权 | POST | `/api/admin/permissions` | ✅ |
| 批量授权 | POST | `/api/admin/permissions/batch` | ✅ |
| 撤销权限 | DELETE | `/api/admin/permissions/:id` | ✅ |
| 审计日志查询 | GET | `/api/admin/audit-logs` | ✅ |
| 告警列表 | GET | `/api/admin/alerts` | ✅ |
| 处置告警 | PUT | `/api/admin/alerts/:id` | ✅ |
| Dashboard 数据 | GET | `/api/admin/dashboard` | ✅ |
| 健康检查 | GET | `/api/health` | ✅ |

---

## 6. 安全措施实现对照表

| 设计要求 | 实现状态 | 实现位置 |
|---------|---------|---------|
| Argon2id 密码哈希 (64MB/3次/4线程) | ✅ | `crypto/argon2.go` |
| 防时序攻击（DummyVerify） | ✅ | `crypto/argon2.go` |
| AES-256-GCM 手机号加密 | ✅ | `crypto/aes.go` |
| K_d 加密存储（KMS） | ✅ | `kms/kms.go` |
| K_d 使用后内存清零 | ✅ | `service/lock_service.go` clearBytes() |
| AES-128-CMAC 挑战应答 | ✅ | `kms/kms.go` ComputeCMAC() |
| 手机号脱敏展示 | ✅ | `crypto/aes.go` MaskPhone() |
| 安全响应头 | ✅ | `middleware/security.go` |
| HMAC-SHA256 Token 签名 | ✅ | `middleware/hmac.go` |
| IP 限流 + 封锁 | ✅ | `middleware/ratelimit.go` |
| RBAC 角色校验 | ✅ | `middleware/auth.go` RBAC() |
| 统一参数校验 | ✅ | Gin Binding Tags |
| 日志敏感字段脱敏 | ✅ | Zap 结构化日志，不记录密码/密钥 |

---

## 7. 并发控制实现对照表

| 并发场景 | 控制方案 | 实现状态 |
|---------|---------|---------|
| 限流计数器并发 | PostgreSQL Upsert 行锁 | ✅ |
| 禁用用户与请求并发 | 鉴权中间件二次校验 users.status | ✅ |
| 重复授权写入 | 唯一索引 + ON CONFLICT DO UPDATE | ✅ |
| 审计日志高并发写入 | RabbitMQ 异步 + 批量写入 | ✅ |
| 告警锁定事务 | BEGIN TRANSACTION 原子操作 | ✅ |

---

## 8. 待完成事项（后续迭代）

### 8.1 高优先级

| 事项 | 说明 |
|------|------|
| `go mod tidy` | 需要在有网络环境下执行，下载所有依赖并生成 go.sum |
| `npm install` | 前端依赖安装 |
| 初始管理员密码 | 迁移脚本中的 placeholder hash 需替换为真实 Argon2id 哈希 |
| CMAC 库替换 | `crypto/cmac` 非标准库，需引入 `github.com/aead/cmac` 或自行实现 |
| `golang.org/x/crypto` 依赖 | Argon2 需要此依赖，需加入 go.mod |

### 8.2 中优先级

| 事项 | 说明 |
|------|------|
| CSV 导出功能 | 审计日志异步导出（设计文档 §8.3），需实现导出任务管理 |
| 短信通知集成 | 密码重置、告警通知的短信发送（阿里云 SMS SDK） |
| App Push 集成 | 告警推送（个推/极光 SDK） |
| 锁具更新接口 | PUT `/api/admin/devices/:id`，目前只实现了创建 |
| 权限矩阵页面 | 虚拟滚动 + 乐观更新，前端高级交互 |
| 非工作时段告警 | 定时任务检测 22:00~06:00 开锁操作 |
| 设备离线检测 | 定时任务检测 last_active_at 超过 30 天 |

### 8.3 低优先级

| 事项 | 说明 |
|------|------|
| 高德地图集成 | 设备位置地图展示 |
| 单元测试 | Service 层核心函数覆盖率 ≥ 80% |
| 集成测试 | Testcontainers + 真实 PostgreSQL |
| k6 压测脚本 | 200 并发混合场景 |
| OWASP ZAP 扫描 | 安全自动化测试 |
| Redis 迁移 | 当触发 §15.1 阈值时执行 |

---

## 9. 启动指南

### 9.1 开发环境启动

```bash
# 1. 启动基础设施
docker-compose up -d postgres rabbitmq

# 2. 后端
cd server
go mod tidy
go run cmd/main.go

# 3. 前端
cd web
npm install
npm run dev
```

### 9.2 生产环境部署

```bash
# 1. 配置环境变量
cp .env.example .env
# 编辑 .env 设置安全密码

# 2. 构建前端
cd web && npm run build

# 3. 启动全部服务
docker-compose up -d --build

# 4. 验证
curl http://localhost/api/health
```

---

## 10. 版本记录

| 版本 | 日期 | 变更说明 |
|------|------|---------|
| V1.0 | 2026-02-19 | 初始骨架搭建完成，全部 API 端点、数据模型、中间件链、前端页面、Docker 编排就绪 |

---

> ※ 本纪要随开发进度持续更新，每次重大变更须同步记录。
