# 树莓派 5 部署指南

## 环境要求

| 项目 | 要求 |
|------|------|
| 树莓派型号 | Raspberry Pi 5 (16GB) |
| 操作系统 | Ubuntu 25.03 (ARM64) |
| 网络 | 与你的 PC 在同一局域网 |
| SSH | 已开启 |

---

## 第一步：获取树莓派 IP 地址

在树莓派终端执行（或通过路由器管理页面查看）：

```bash
hostname -I
```

记下输出的局域网 IP，例如 `192.168.1.200`。后面用 `<PI_IP>` 表示这个地址。

---

## 第二步：树莓派上安装 Docker

SSH 连接到树莓派：

```bash
ssh <用户名>@<PI_IP>
```

安装 Docker：

```bash
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER
```

**退出 SSH 并重新登录**，使 docker 组权限生效。

验证安装：

```bash
docker --version
docker compose version
```

两个命令都应该输出版本号。如果 `docker compose` 不可用，安装插件：

```bash
sudo apt-get install docker-compose-plugin
```

---

## 第三步：从 PC 传输项目到树莓派

在你的 **Mac PC** 终端执行：

```bash
# 传输整个项目（包含 .env 文件）
scp -r /Users/reality/Documents/Promthus <用户名>@<PI_IP>:~/

# 单独传输 .env（scp -r 不会跳过隐藏文件，但确认一下）
scp /Users/reality/Documents/Promthus/.env <用户名>@<PI_IP>:~/Promthus/
```

> 如果项目较大，也可以用 rsync：
> ```bash
> rsync -avz --progress /Users/reality/Documents/Promthus/ <用户名>@<PI_IP>:~/Promthus/
> ```

---

## 第四步：在树莓派上启动服务

SSH 到树莓派：

```bash
ssh <用户名>@<PI_IP>
cd ~/Promthus
```

首次启动（会自动构建镜像，大约需要 10-20 分钟）：

```bash
docker compose -f docker-compose.pi.yml up -d --build
```

查看构建和启动日志：

```bash
# 跟踪所有服务日志
docker compose -f docker-compose.pi.yml logs -f

# 只看某个服务的日志
docker compose -f docker-compose.pi.yml logs -f lock-service-1
```

检查所有服务是否正常运行：

```bash
docker compose -f docker-compose.pi.yml ps
```

所有服务的 STATUS 应为 `Up` 或 `healthy`。

---

## 第五步：从 PC 浏览器访问

打开浏览器，输入：

```
http://<PI_IP>
```

例如 `http://192.168.1.200`，即可看到管控平台登录页面。

默认管理员账号（来自数据库初始化脚本）：
- 用户名：`admin`
- 密码：`admin123`（首次登录后请立即修改）

---

## 常用运维命令

```bash
# 进入项目目录
cd ~/Promthus

# 停止所有服务
docker compose -f docker-compose.pi.yml down

# 重启所有服务
docker compose -f docker-compose.pi.yml restart

# 重新构建并启动（代码更新后）
docker compose -f docker-compose.pi.yml up -d --build

# 查看资源占用
docker stats

# 查看 PostgreSQL 数据
docker exec -it promthus-postgres psql -U promthus -d promthus

# 查看 RabbitMQ 管理页面
# 浏览器访问 http://<PI_IP>:15672
# 账号密码见 .env 文件

# 清理未使用的镜像（释放磁盘空间）
docker system prune -f
```

---

## 常见问题

### Q: 构建时 npm install 很慢？

树莓派上 npm install 在 ARM64 环境下可能较慢，这是正常的。首次构建耗时较长，后续重建会利用 Docker 缓存。

如果网络不好，可以配置 npm 镜像：在 `web/Dockerfile` 的 `RUN npm install` 之前加一行：

```dockerfile
RUN npm config set registry https://registry.npmmirror.com
```

### Q: Go 编译很慢？

首次在 ARM64 上编译 Go 项目较慢（5-10 分钟），后续有缓存会快很多。

### Q: 树莓派 IP 变了怎么办？

在路由器管理页面中，给树莓派绑定静态 IP（DHCP 静态绑定）。找到树莓派的 MAC 地址，绑定一个固定的局域网 IP。

### Q: 数据持久化在哪？

PostgreSQL 和 RabbitMQ 的数据通过 Docker volumes 持久化。即使容器删除重建，数据不会丢失。

如果需要**完全清除数据**重来：

```bash
docker compose -f docker-compose.pi.yml down -v
```

`-v` 参数会同时删除 volumes。

---

## 代理配置（可选：让树莓派走 PC 上的 Clash）

若需要树莓派全部流量走你笔记本的 Clash 代理（例如拉镜像、npm/go 依赖加速），按下面三步做。前提：PC 与树莓派同网段，且 Clash 默认 HTTP 代理端口为 7890。

### 1. PC 上开启 Clash 局域网访问

在 Clash 里打开 **Allow LAN**（允许局域网连接）。  
验证（在树莓派上执行，`<PC_IP>` 换成你笔记本的局域网 IP）：

```bash
curl -x http://<PC_IP>:7890 -I https://www.google.com
```

能返回 HTTP 头即表示代理可达。

### 2. 树莓派系统级代理

在树莓派上编辑 `~/.bashrc`（或 `~/.zshrc`），追加（把 `YOUR_PC_IP` 换成实际 PC IP）：

```bash
export http_proxy="http://YOUR_PC_IP:7890"
export https_proxy="http://YOUR_PC_IP:7890"
export no_proxy="localhost,127.0.0.1,192.168.0.0/16"
```

执行 `source ~/.bashrc` 生效。也可复制项目内 [deploy/pi-proxy-env.sh.example](deploy/pi-proxy-env.sh.example) 到树莓派，替换 IP 后 `source` 或追加到 `~/.bashrc`。

### 3. Docker 守护进程代理（docker pull 走代理）

在树莓派上创建或合并 `/etc/docker/daemon.json`（可参考 [deploy/daemon-proxy.json.example](deploy/daemon-proxy.json.example)，将 `YOUR_PC_IP` 换成 PC IP）：

```json
{
  "proxies": {
    "http-proxy": "http://YOUR_PC_IP:7890",
    "https-proxy": "http://YOUR_PC_IP:7890",
    "no-proxy": "localhost,127.0.0.1,192.168.0.0/16"
  }
}
```

然后重启 Docker：`sudo systemctl restart docker`。

### 4. Docker 构建时代理（npm install / go mod download 走代理）

在项目根目录的 `.env` 中设置（把 `<PC_IP>` 换成你笔记本的局域网 IP）：

```bash
PROXY_URL=http://<PC_IP>:7890
```

未设置或留空时，构建不会使用代理。设置后，`docker compose -f docker-compose.pi.yml build` 时 BuildKit 会将代理传给构建过程。

### 5. 验证代理

在树莓派上依次验证：

```bash
# 系统代理（需已 source 含上述 export 的 shell 配置）
curl -I https://www.google.com

# Docker pull
docker pull alpine:latest

# 构建（若已配置 PROXY_URL）
cd ~/Promthus && docker compose -f docker-compose.pi.yml build
```

注意：PC 需保持开机且 Clash 运行，否则树莓派通过代理的请求会失败。`no_proxy` 已排除局域网，容器间通信（如 Go 连 PostgreSQL）不会走代理。

---

## 系统架构概览

```
你的 PC 浏览器
      |
      | HTTP (端口 80)
      v
 树莓派 Nginx (:80)
      |
      ├── /api/*  →  Go 服务 1 (:8080)  ──→  PostgreSQL (:5432)
      |                                   └──→  RabbitMQ  (:5672)
      |
      ├── /api/*  →  Go 服务 2 (:8080)  ──→  PostgreSQL
      |                                   └──→  RabbitMQ
      |
      └── /*      →  Vue 静态文件 (HTML/JS/CSS)
```

Nginx 对 `/api/` 请求做负载均衡（轮询到两个 Go 实例），其他请求返回 Vue 前端静态文件。
